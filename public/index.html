<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram –†—É–ª–µ—Ç–∫–∞</title>
  <style>
    body { margin: 0; font-family: sans-serif; background-color: #f3f3f3; }
    .tab { display: none; padding: 20px; text-align: center; }
    .tab.active { display: block; }
    .navbar {
      position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around;
      background-color: #fff; border-top: 1px solid #ccc;
    }
    .navbar button { flex: 1; padding: 15px; background: none; border: none; font-size: 16px; }
    .navbar button.active { background-color: #e0e0e0; }
    .balance { position: absolute; top: 10px; right: 15px; font-weight: bold; }
    .wheel-container {
      position: relative; width: 300px; height: 300px; margin: 80px auto 20px auto;
    }
    .arrow {
      width: 0; height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 25px solid red;
      position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
      z-index: 10;
    }
    canvas { display: block; }
  </style>
</head>
<body>

<div id="auth" style="text-align:center; padding:40px">
  <h2>üéÆ –†—É–ª–µ—Ç–∫–∞ Telegram</h2>
  <button onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
  <div id="loginError" style="color:red;margin-top:10px"></div>
  <div id="tg-login" style="margin-top: 20px;"></div>
</div>

<div id="mainApp" style="display:none">
  <div class="balance">–ú–æ–Ω–µ—Ç—ã: <span id="coinBalance">0</span></div>

  <div id="tab1" class="tab active">
    <div class="wheel-container">
      <div class="arrow"></div>
      <canvas id="wheelCanvas" width="300" height="300"></canvas>
    </div>
    <button onclick="spinWheel()">–ö—Ä—É—Ç–∏—Ç—å –∑–∞ –º–æ–Ω–µ—Ç—ã</button>
    <div id="resultText" style="margin-top: 10px; font-weight: bold;"></div>
  </div>

  <div id="tab2" class="tab">–†–æ–∑—ã–≥—Ä—ã—à–∏ (–∑–∞–≥–ª—É—à–∫–∞)</div>

  <div id="tab3" class="tab">
    –ú–µ–Ω—é<br><br>
    <button onclick="connectWallet()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å Telegram Wallet</button>
  </div>

  <div class="navbar">
    <button id="btn1" class="active" onclick="showTab(1)">–ö–æ–ª–µ—Å–æ</button>
    <button id="btn2" onclick="showTab(2)">–†–æ–∑—ã–≥—Ä—ã—à–∏</button>
    <button id="btn3" onclick="showTab(3)">–ú–µ–Ω—é</button>
  </div>
</div>

<script>
  const prizes = ["5 –º–æ–Ω–µ—Ç", "–ù–∏—á–µ–≥–æ", "10 –º–æ–Ω–µ—Ç", "TON", "–ü–æ–¥–∞—Ä–æ–∫ (–æ–±—ã—á–Ω—ã–π)", "–ü–æ–¥–∞—Ä–æ–∫ (—Ä–µ–¥–∫–∏–π)", "–ü–æ–¥–∞—Ä–æ–∫ (—ç–ø–∏—á–µ—Å–∫–∏–π)"];
  let coinBalance = 0, userId = null, rotation = 0, spinning = false;

  function showTab(index) {
    for (let i = 1; i <= 3; i++) {
      document.getElementById('tab' + i).classList.remove('active');
      document.getElementById('btn' + i).classList.remove('active');
    }
    document.getElementById('tab' + index).classList.add('active');
    document.getElementById('btn' + index).classList.add('active');
  }

  function connectWallet() {
    alert("–ó–¥–µ—Å—å –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram Wallet");
  }

  async function loadBalance() {
    const res = await fetch(`https://telegramwheelprize.onrender.com/balance/${userId}`);
    const data = await res.json();
    coinBalance = data.balance || 100;
    document.getElementById("coinBalance").textContent = coinBalance;
  }

  async function saveBalance() {
    await fetch(`https://telegramwheelprize.onrender.com/balance/${userId}`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ balance: coinBalance })
    });
  }

  function spinWheel() {
    if (spinning || coinBalance < 25) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç");
    coinBalance -= 25;
    document.getElementById("coinBalance").textContent = coinBalance;
    saveBalance();
    spinning = true;

    const spinAngle = Math.random() * 360 + 360 * 5;
    const duration = 4000;
    const startRotation = rotation;
    const finalRotation = startRotation + (spinAngle * Math.PI / 180);
    const start = performance.now();

    function animate(time) {
      const elapsed = time - start;
      const progress = Math.min(elapsed / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3);
      rotation = startRotation + (finalRotation - startRotation) * eased;
      drawWheel();
      if (progress < 1) requestAnimationFrame(animate);
      else { spinning = false; determinePrize(); }
    }

    requestAnimationFrame(animate);
  }

  function determinePrize() {
    const anglePerSegment = 360 / prizes.length;
    let deg = (rotation * 180 / Math.PI) % 360;
    if (deg < 0) deg += 360;
    const pointerDeg = 270;
    const relativeDeg = (pointerDeg - deg + 360) % 360;
    const index = Math.floor(relativeDeg / anglePerSegment);
    const prize = prizes[index];
    document.getElementById("resultText").textContent = `–í—ã–ø–∞–ª–æ: ${prize}`;
    if (prize === "5 –º–æ–Ω–µ—Ç") coinBalance += 5;
    if (prize === "10 –º–æ–Ω–µ—Ç") coinBalance += 10;
    document.getElementById("coinBalance").textContent = coinBalance;
    saveBalance();
  }

  function drawWheel() {
    const canvas = document.getElementById("wheelCanvas");
    const ctx = canvas.getContext("2d");
    const radius = canvas.width / 2;
    const center = { x: radius, y: radius };
    const angle = 2 * Math.PI / prizes.length;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < prizes.length; i++) {
      const startAngle = i * angle + rotation;
      const endAngle = startAngle + angle;
      ctx.beginPath();
      ctx.moveTo(center.x, center.y);
      ctx.arc(center.x, center.y, radius, startAngle, endAngle);
      ctx.fillStyle = i % 2 === 0 ? "#f8b500" : "#ffdd57";
      ctx.fill();
      ctx.stroke();
      ctx.save();
      ctx.translate(center.x, center.y);
      ctx.rotate(startAngle + angle / 2);
      ctx.textAlign = "right";
      ctx.fillStyle = "#000";
      ctx.font = "14px sans-serif";
      ctx.fillText(prizes[i], radius - 10, 5);
      ctx.restore();
    }
  }

  function startGame() {
    const user = window.Telegram?.WebApp?.initDataUnsafe?.user;
    if (user?.id) {
      userId = user.id.toString();
      document.getElementById("auth").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
      drawWheel();
      loadBalance();
    } else {
      showLoginWidget();
    }
  }

  function showLoginWidget() {
    document.getElementById('loginError').textContent = '';
    document.getElementById('tg-login').innerHTML = '';
    const script = document.createElement("script");
    script.src = "https://telegram.org/js/telegram-widget.js?7";
    script.setAttribute("data-telegram-login", "WheelPrizeBot");
    script.setAttribute("data-size", "large");
    script.setAttribute("data-userpic", "false");
    script.setAttribute("data-request-access", "write");
    script.setAttribute("data-onauth", "onTelegramAuth(user)");
    document.getElementById("tg-login").appendChild(script);
  }

  async function onTelegramAuth(user) {
    try {
      const res = await fetch("https://telegramwheelprize.onrender.com/auth", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(user)
      });
      if (res.ok) {
        const result = await res.json();
        userId = result.user.id.toString();
        document.getElementById("auth").style.display = "none";
        document.getElementById("mainApp").style.display = "block";
        drawWheel();
        loadBalance();
      } else {
        document.getElementById("loginError").textContent = "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram.";
      }
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", err);
      document.getElementById("loginError").textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.";
    }
  }
</script>
</body>
</html>
